<!DOCTYPE html>

<html>
<head>
  <title>core.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="edit.html">
                edit.js
              </a>
            
              
              <a class="source" href="chat.html">
                chat.js
              </a>
            
              
              <a class="source" href="drawing.html">
                drawing.js
              </a>
            
              
              <a class="source" href="equations.html">
                equations.js
              </a>
            
              
              <a class="source" href="note.html">
                note.js
              </a>
            
              
              <a class="source" href="page.html">
                page.js
              </a>
            
              
              <a class="source" href="presentation.html">
                presentation.js
              </a>
            
              
              <a class="source" href="resize.html">
                resize.js
              </a>
            
              
              <a class="source" href="spreadsheet.html">
                spreadsheet.js
              </a>
            
              
              <a class="source" href="tables.html">
                tables.js
              </a>
            
              
              <a class="source" href="backend.html">
                backend.js
              </a>
            
              
              <a class="source" href="main.html">
                main.rb
              </a>
            
              
              <a class="source" href="models.html">
                models.rb
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>core.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
    WebSync: Core.js
    This is the core file that runs the WebSync editor.

    Copyright (c) 2014. All Rights reserved.

    Tristan Rice
    rice (at) outerearth (dot) net
    http://tristanrice.name/
*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Variable: object WebSync;
This is the core of WebSync. Everything is stored under the WebSync object except for websocket authentication information which is under WebSyncAuth, and the main WebSyncData object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define(<span class="hljs-string">'websync'</span>, {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Variable: object WebSync.tmp;
Provides a location for temporary data to be stored.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    tmp: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Variable: boolean WebSync.webSocketFirstTime;
Websocket first connection?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    webSocketFirstTime: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Function: void WebSync.webSocketStart();
Creates the websocket for communication.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    webSocketStart: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> protocol = <span class="hljs-string">'ws'</span>;
        <span class="hljs-keyword">var</span> path = window.location.hostname + <span class="hljs-string">':'</span> + WebSyncAuth.websocket_port;
        <span class="hljs-keyword">if</span> (window.location.protocol == <span class="hljs-string">'https:'</span>) {
            protocol = <span class="hljs-string">'wss'</span>;
            path = WebSyncAuth.websocket_url;
        }
        WebSync.connection = <span class="hljs-keyword">new</span> WebSocket(protocol + <span class="hljs-string">"://"</span> + path + window.location.pathname);
        WebSync.connection.onopen = WebSync.webSocketCallbacks.onopen;
        WebSync.connection.onclose = WebSync.webSocketCallbacks.onclose;
        WebSync.connection.onmessage = WebSync.webSocketCallbacks.onmessage;
        WebSync.connection.onerror = WebSync.webSocketCallbacks.onerror;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Variable: object WebSync.webSocketCallbacks;
An object with all of the callbacks for a websocket connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    webSocketCallbacks: {
        onopen: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            console.log(e);
            WebSync.diffInterval = setInterval(WebSync.checkDiff, <span class="hljs-number">1000</span>);
            $(<span class="hljs-string">"nav"</span>).removeClass(<span class="hljs-string">"no-connection"</span>);
            $(document).trigger(<span class="hljs-string">"connection"</span>);
            $(<span class="hljs-string">"#connection_msg"</span>).remove();
            $(<span class="hljs-string">"#fatal_error"</span>).fadeOut();
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                <span class="hljs-keyword">if</span> (WebSync.webSocketFirstTime) {
                    WebSync.connection.sendJSON({
                        type: <span class="hljs-string">'auth'</span>,
                        id: WebSyncAuth.id,
                        key: WebSyncAuth.key
                    });
                } <span class="hljs-keyword">else</span> {
                    WebSync.connection.sendJSON({
                        type: <span class="hljs-string">'auth'</span>,
                        id: WebSyncAuth.id,
                        key: WebSyncAuth.key
                    });
                    WebSync.success(<span class="hljs-string">"&lt;strong&gt;Success!&lt;/strong&gt; Connection restablished."</span>);
                }
            }, <span class="hljs-number">100</span>);
        },

        onclose: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            console.log(e);
            <span class="hljs-keyword">if</span> (WebSync.diffInterval) {
                clearInterval(WebSync.diffInterval);
                $(<span class="hljs-string">"nav"</span>).addClass(<span class="hljs-string">"no-connection"</span>);
                WebSync.error(<span class="hljs-string">"&lt;strong&gt;Connection Lost!&lt;/strong&gt; Server is currently unavailable."</span>).get(<span class="hljs-number">0</span>).id = <span class="hljs-string">"connection_msg"</span>;
                WebSync.diffInterval = <span class="hljs-literal">null</span>;
                $(document).trigger(<span class="hljs-string">"noconnection"</span>);
            } <span class="hljs-keyword">else</span> {
                WebSync.fatalError(<span class="hljs-string">"Failed to connect to backend."</span>);
            }
            setTimeout(WebSync.webSocketStart, <span class="hljs-number">2000</span>);
        },
        onmessage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            console.log(e);
            data = <span class="hljs-built_in">JSON</span>.parse(e.data);
            console.log(<span class="hljs-string">"Message data:"</span>, data);
            <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">"scripts"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Load scripts from server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-built_in">require</span>(data.js);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'data_patch'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Get start selection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> sel = getSelection();
                <span class="hljs-keyword">var</span> range, startText, startOffset, endText, endOffset;
                <span class="hljs-keyword">if</span> (sel.rangeCount &gt; <span class="hljs-number">0</span>) {
                    range = sel.getRangeAt(<span class="hljs-number">0</span>);
                    startText = range.startContainer.nodeValue;
                    startOffset = range.startOffset;
                    endText = range.endContainer.nodeValue;
                    endOffset = range.endOffset;
                }
                WebSync.tmp.range = {
                    active: (sel.rangeCount &gt; <span class="hljs-number">0</span>),
                    startText: startText,
                    startOffset: startOffset,
                    endText: endText,
                    endOffset: endOffset
                }
                $(document).trigger(<span class="hljs-string">"data_patch"</span>, {
                    patch: data.patch
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Make sure there aren’t any outstanding changes that need to be sent before patching document.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                WebSync.checkDiff();
                jsonpatch.unobserve(WebSyncData, WebSync.patchObserver);
                jsonpatch.apply(WebSyncData, data.patch);
                WebSync.patchObserver = jsonpatch.observe(WebSyncData);
                <span class="hljs-keyword">if</span> (WebSync.fromJSON) {
                    WebSync.fromJSON(data.patch);
                }
                sel = WebSync.tmp.range;
                <span class="hljs-keyword">if</span> (sel.active) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Find all #text nodes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> text_nodes = $(<span class="hljs-string">".content"</span>).find(<span class="hljs-string">":not(iframe)"</span>).addBack().contents().filter(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.nodeType == <span class="hljs-number">3</span>;
                    });
                    <span class="hljs-keyword">var</span> startText = sel.startText,
                        startOffset = sel.startOffset,
                        endText = sel.endText,
                        endOffset = sel.endOffset;
                    <span class="hljs-keyword">var</span> startNode = {};
                    <span class="hljs-keyword">var</span> endNode = {};
                    console.log(text_nodes);
                    <span class="hljs-keyword">var</span> startNodeDist = <span class="hljs-number">99999</span>;
                    <span class="hljs-keyword">var</span> endNodeDist = <span class="hljs-number">99999</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Locate the start &amp; end #text nodes based on a Levenstein string distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    text_nodes.each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(index, node)</span> {</span>
                        <span class="hljs-keyword">var</span> dist = levenshteinenator(node.nodeValue, startText);
                        <span class="hljs-keyword">if</span> (dist &lt; startNodeDist) {
                            startNode = node;
                            startNodeDist = dist;
                        }
                        dist = levenshteinenator(node.nodeValue, endText);
                        <span class="hljs-keyword">if</span> (dist &lt; endNodeDist) {
                            endNode = node;
                            endNodeDist = dist;
                        }
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Update the text range.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> range = document.createRange();
                    range.setStart(startNode, startOffset);
                    range.setEnd(endNode, endOffset);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">"name_update"</span>) {
                $(<span class="hljs-string">"#name"</span>).text(data.name);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'ping'</span>) {
                WebSync.connection.sendJSON({
                    type: <span class="hljs-string">'ping'</span>
                });
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">"permissions"</span>) {
                $(<span class="hljs-string">"#access_mode"</span>).val(data.visibility);
                $(<span class="hljs-string">"#default_permissions"</span>).val(data.default_level);
                <span class="hljs-keyword">var</span> users = $(<span class="hljs-string">"#user_perms tbody"</span>);
                <span class="hljs-keyword">var</span> html = <span class="hljs-string">""</span>;
                _.each(data.users, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(user)</span> {</span>
                    html += <span class="hljs-string">"&lt;tr&gt;"</span>;
                    html += <span class="hljs-string">"&lt;td&gt;"</span> + user.user_email + <span class="hljs-string">"&lt;/td&gt;&lt;td&gt;&lt;select class='form-control'"</span>
                    <span class="hljs-keyword">if</span> (WebSync.clients[WebSyncAuth.id].email == user.user_email) html += <span class="hljs-string">" disabled"</span>
                    html += <span class="hljs-string">"&gt;"</span>
                    _.each([<span class="hljs-string">"viewer"</span>, <span class="hljs-string">"editor"</span>, <span class="hljs-string">"owner"</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(level)</span> {</span>
                        html += <span class="hljs-string">"&lt;option value='"</span> + level + <span class="hljs-string">"'"</span>
                        <span class="hljs-keyword">if</span> (level == user.level) html += <span class="hljs-string">" selected"</span>
                        html += <span class="hljs-string">"&gt;"</span>
                        html += level.charAt(<span class="hljs-number">0</span>).toUpperCase() + level.slice(<span class="hljs-number">1</span>)
                        html += <span class="hljs-string">"&lt;/option&gt;"</span>
                    });
                    html += <span class="hljs-string">"&lt;/select&gt;&lt;/td&gt;&lt;td&gt;&lt;a class='btn btn-danger'"</span>
                    <span class="hljs-keyword">if</span> (WebSync.clients[WebSyncAuth.id].email == user.user_email) html += <span class="hljs-string">" disabled"</span>
                    html += <span class="hljs-string">"&gt;&lt;i class='fa fa-trash-o visible-xs fa-lg'&gt;&lt;/i&gt; &lt;span class='hidden-xs'&gt;Delete&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;"</span>
                    html += <span class="hljs-string">"&lt;/tr&gt;"</span>;
                });
                users.html(html);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'config'</span>) {
                <span class="hljs-keyword">if</span> (data.action == <span class="hljs-string">'get'</span>) {
                    <span class="hljs-keyword">var</span> callback = WebSync._config_callbacks[data.id]
                    <span class="hljs-keyword">if</span> (callback) {
                        callback(data.property, data.value, data.space);
                        <span class="hljs-keyword">delete</span> WebSync._config_callbacks[data.id];
                    }
                }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">"error"</span>) {
                WebSync.error(data.reason);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'info'</span>) {
                WebSync.webSocketFirstTime = <span class="hljs-literal">false</span>;
                WebSync.loadScripts();
                WebSync.connection.sendJSON({
                    type: <span class="hljs-string">'config'</span>,
                    action: <span class="hljs-string">'get'</span>,
                    property: <span class="hljs-string">'public'</span>
                });
                WebSync.clients = data[<span class="hljs-string">'users'</span>];
                <span class="hljs-keyword">var</span> to_trigger = {};
                $.each(WebSync.clients, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k, v)</span> {</span>
                    console.log(k, v);
                    <span class="hljs-keyword">if</span> (v.email == <span class="hljs-string">"anon@websyn.ca"</span>) {
                        WebSync.users[v.id] = {
                            displayName: <span class="hljs-string">"Anonymous"</span>
                        };
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!WebSync.users[v.id]) {
                        to_trigger[v.id] = [k];
                        $.ajax({
                            url: <span class="hljs-string">"https://secure.gravatar.com/"</span> + v.id + <span class="hljs-string">".json"</span>,
                            dataType: <span class="hljs-string">'jsonp'</span>,
                            timeout: <span class="hljs-number">2000</span>
                        }).done(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                            WebSync.users[v.id] = data.entry[<span class="hljs-number">0</span>];
                        }).complete(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                            $.each(to_trigger[v.id], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i, item)</span> {</span>
                                $(document).trigger(<span class="hljs-string">'client_load'</span>, {
                                    client: item
                                });
                            });
                        })
                        WebSync.users[v.id] = {};
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (!to_trigger[v.id]) {
                            $(document).trigger(<span class="hljs-string">'client_load'</span>, {
                                client: k
                            });
                        } <span class="hljs-keyword">else</span> {
                            to_trigger[v.id].push(k);
                        }
                    }
                });
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'new_user'</span>) {
                WebSync.clients[data[<span class="hljs-string">'id'</span>]] = data[<span class="hljs-string">'user'</span>];
                <span class="hljs-keyword">var</span> user_id = data[<span class="hljs-string">'user'</span>].id;
                <span class="hljs-keyword">var</span> client_id = data[<span class="hljs-string">'id'</span>]
                console.log(<span class="hljs-string">"USER INFO"</span>, data);
                <span class="hljs-keyword">if</span> (data[<span class="hljs-string">'user'</span>].email == <span class="hljs-string">"anon@websyn.ca"</span>) {
                    WebSync.users[data[<span class="hljs-string">'id'</span>]] = {
                        displayName: <span class="hljs-string">"Anonymous"</span>
                    };
                }
                <span class="hljs-keyword">if</span> (!WebSync.users[data[<span class="hljs-string">'user'</span>].id]) {
                    $.ajax({
                        url: <span class="hljs-string">"https://secure.gravatar.com/"</span> + data[<span class="hljs-string">'user'</span>].id + <span class="hljs-string">".json"</span>,
                        dataType: <span class="hljs-string">'jsonp'</span>
                    }).done(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
                        console.log(data);
                        WebSync.users[user_id] = data.entry[<span class="hljs-number">0</span>];
                        $(document).trigger(<span class="hljs-string">'client_load'</span>, {
                            client: client_id
                        });
                    }).fail(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                        $(document).trigger(<span class="hljs-string">'client_load'</span>, {
                            client: client_id
                        });
                    });
                    WebSync.users[data[<span class="hljs-string">'user'</span>].id] = {};
                } <span class="hljs-keyword">else</span> {
                    $(document).trigger(<span class="hljs-string">'client_load'</span>, {
                        client: data[<span class="hljs-string">'id'</span>]
                    });
                }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'exit_user'</span>) {
                <span class="hljs-keyword">delete</span> WebSync.clients[data[<span class="hljs-string">'id'</span>]];
                $(document).trigger(<span class="hljs-string">'client_leave'</span>, {
                    client: data[<span class="hljs-string">'id'</span>]
                });
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'client_event'</span>) {
                $(document).trigger(<span class="hljs-string">'client_event_'</span> + data.event, {
                    from: data.from,
                    data: data.data
                });
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'asset_list'</span>) {
                <span class="hljs-keyword">var</span> row = $(<span class="hljs-string">"&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td width='102px'&gt;&lt;div class='switch' &gt;&lt;input type='checkbox' "</span> + (($(<span class="hljs-string">"script[src='"</span> + data.url + <span class="hljs-string">"']"</span>).length &gt; <span class="hljs-number">0</span>) ? <span class="hljs-string">"checked"</span> : <span class="hljs-string">""</span>) + <span class="hljs-string">"/&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;"</span>);
                row.get(<span class="hljs-number">0</span>).dataset[<span class="hljs-string">'id'</span>] = data.id;
                <span class="hljs-keyword">var</span> children = row.children();
                children.get(<span class="hljs-number">0</span>).innerText = data.name;
                children.get(<span class="hljs-number">1</span>).innerText = data.description;
                children.get(<span class="hljs-number">2</span>).innerText = data.url;
                children.get(<span class="hljs-number">3</span>).innerText = data.atype;
                $($(children.get(<span class="hljs-number">4</span>)).children().get(<span class="hljs-number">0</span>)).bootstrapSwitch();
                $(<span class="hljs-string">"#assets tbody"</span>).append(row);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.type == <span class="hljs-string">'diff_list'</span>) {
                WebSync.patches = data.patches;
                _.each(WebSync.patches, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(patch)</span> {</span>
                    <span class="hljs-keyword">var</span> row = $(<span class="hljs-string">"&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;button class='btn btn-warning' data-id='"</span> + patch.id + <span class="hljs-string">"'&gt;Revert To&lt;/button&gt;&lt;/td&gt;&lt;/tr&gt;"</span>);
                    <span class="hljs-keyword">var</span> children = row.children();
                    children.get(<span class="hljs-number">0</span>).innerText = patch.time;
                    children.get(<span class="hljs-number">1</span>).innerText = patch.patch;
                    children.get(<span class="hljs-number">2</span>).innerText = patch.user_email;
                    $($(children.get(<span class="hljs-number">4</span>)).children().get(<span class="hljs-number">0</span>)).bootstrapSwitch();
                    $(<span class="hljs-string">"#diffs tbody"</span>).prepend(row);
                });
            }
        },
        onerror: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            console.log(e);
        }

    },
    broadcastEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event, data)</span> {</span>
        WebSync.connection.sendJSON({
            type: <span class="hljs-string">'client_event'</span>,
            event: event,
            data: data
        });
    },
    users: {},
    _config_callbacks: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Function: void WebSync.config_set(string key, object value, string space);
Sends a request to the server to set config[key] to value. Space can be “user” or “document”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    config_set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, value, space)</span> {</span>
        <span class="hljs-keyword">if</span> (space == <span class="hljs-literal">null</span>) {
            space = <span class="hljs-string">'document'</span>;
        }
        WebSync.connection.sendJSON({
            type: <span class="hljs-string">'config'</span>,
            action: <span class="hljs-string">'set'</span>,
            property: key,
            value: value,
            space: space
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Function: void WebSync.config_get(string key, string space);
Sends a request to the server for the key value. Space can be “user” or “document”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    config_get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, callback, space)</span> {</span>
        <span class="hljs-keyword">var</span> id = btoa(<span class="hljs-built_in">Date</span>.now());
        <span class="hljs-keyword">if</span> (callback) {
            WebSync._config_callbacks[id] = callback;
        }
        <span class="hljs-keyword">if</span> (space == <span class="hljs-literal">null</span>) {
            space = <span class="hljs-string">'document'</span>;
        }
        WebSync.connection.sendJSON({
            type: <span class="hljs-string">'config'</span>,
            action: <span class="hljs-string">'get'</span>,
            property: key,
            space: space,
            id: id
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Function: void WebSync.initialize();
This is where the core of WebSync initializes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initialize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        NProgress.start();
        <span class="hljs-keyword">this</span>.webSocketStart();
        $(<span class="hljs-string">"#settingsBtn, [href='#permissions']"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            WebSync.connection.sendJSON({
                type: <span class="hljs-string">"permission_info"</span>
            });
        });
        $(<span class="hljs-string">"#user_perms"</span>).delegate(<span class="hljs-string">"select"</span>, <span class="hljs-string">"change"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">var</span> email = $(e.target).parent().parent().children().eq(<span class="hljs-number">0</span>).text();
            <span class="hljs-keyword">var</span> choice = $(e.target).val();
            WebSync.connection.sendJSON({
                type: <span class="hljs-string">'share'</span>,
                email: email,
                level: choice
            });
        });
        $(<span class="hljs-string">"#user_perms"</span>).delegate(<span class="hljs-string">"a"</span>, <span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">var</span> email = $(e.target).parent().parent().children().eq(<span class="hljs-number">0</span>).text();
            WebSync.connection.sendJSON({
                type: <span class="hljs-string">'share'</span>,
                email: email,
                level: <span class="hljs-string">"delete"</span>
            });
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                WebSync.connection.sendJSON({
                    type: <span class="hljs-string">"permission_info"</span>
                });
            }, <span class="hljs-number">200</span>);
        });
        $(<span class="hljs-string">"#share_with"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> email = $(<span class="hljs-string">"#share_email"</span>).val();
            WebSync.connection.sendJSON({
                type: <span class="hljs-string">"share"</span>,
                email: email,
                level: <span class="hljs-string">"viewer"</span>
            });
            setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                WebSync.connection.sendJSON({
                    type: <span class="hljs-string">"permission_info"</span>
                });
            }, <span class="hljs-number">200</span>);
            $(<span class="hljs-string">"#share_email"</span>).val(<span class="hljs-string">""</span>);
        });
        $(<span class="hljs-string">"#access_mode, #default_permissions"</span>).change(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (WebSyncAuth.access == <span class="hljs-string">"owner"</span>) {
                WebSync.connection.sendJSON({
                    type: <span class="hljs-string">'default_permissions'</span>,
                    visibility: $(<span class="hljs-string">"#access_mode"</span>).val(),
                    default_level: $(<span class="hljs-string">"#default_permissions"</span>).val()
                });
            } <span class="hljs-keyword">else</span> {
                WebSync.error(<span class="hljs-string">"Invalid permissions."</span>);
            }
        });
        $(<span class="hljs-string">"#name"</span>).blur(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> name = $(<span class="hljs-keyword">this</span>).text();
            document.title = name + <span class="hljs-string">" - WebSync"</span>;
            WebSync.connection.sendJSON({
                type: <span class="hljs-string">"name_update"</span>,
                name: name
            });
        });
        $(<span class="hljs-string">"#name"</span>).keydown(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            e.stopPropagation();
        });
        $(<span class="hljs-string">"#name"</span>).focus(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.innerText.indexOf(<span class="hljs-string">"Unnamed"</span>) == <span class="hljs-number">0</span>) {
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    document.execCommand(<span class="hljs-string">'selectAll'</span>);
                }, <span class="hljs-number">100</span>);
            }
        });
        $(<span class="hljs-string">".settings-popup #config"</span>).delegate(<span class="hljs-string">'button'</span>, <span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            $(<span class="hljs-keyword">this</span>.parentElement.children[<span class="hljs-number">0</span>]).prop(<span class="hljs-string">'disabled'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_, val)</span> {</span>
                <span class="hljs-keyword">return</span> !val;
            });
            $(<span class="hljs-keyword">this</span>).toggleClass(<span class="hljs-string">"active"</span>);
        });
        $(<span class="hljs-string">"nav, .content_well"</span>).bind(<span class="hljs-string">"mousedown selectstart"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (e.target.tagName != <span class="hljs-string">"SELECT"</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        });
        $(<span class="hljs-string">"#name, #permissions input[type=text]"</span>).bind(<span class="hljs-string">"mousedown selectstart"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            e.stopPropagation();
        });
        $(<span class="hljs-string">'#zoom_level'</span>).slider()
            .on(<span class="hljs-string">'slide'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
                WebSync.setZoom($(<span class="hljs-string">'#zoom_level'</span>).data(<span class="hljs-string">"slider"</span>).getValue() / <span class="hljs-number">100.0</span>)

            });
        $(<span class="hljs-string">'body'</span>).mousemove(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            <span class="hljs-keyword">if</span> (WebSync.viewMode == <span class="hljs-string">'Zen'</span>) {
                <span class="hljs-keyword">if</span> (e.pageY &lt; <span class="hljs-number">85</span> &amp;&amp; !WebSync.menuVisible) {
                    $(<span class="hljs-string">"nav"</span>).animate({
                        top: <span class="hljs-number">0</span>
                    }, <span class="hljs-number">200</span>);
                    WebSync.menuVisible = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.pageY &gt; <span class="hljs-number">85</span> &amp;&amp; WebSync.menuVisible) {
                    $(<span class="hljs-string">"nav"</span>).animate({
                        top: -<span class="hljs-number">95</span>
                    }, <span class="hljs-number">200</span>);
                    WebSync.menuVisible = <span class="hljs-literal">false</span>;
                }
            }
        });
        WebSync.urlChange();
        $(window).bind(<span class="hljs-string">"popstate"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            WebSync.urlChange();
        });
        $(<span class="hljs-string">'#view_mode'</span>).change(WebSync.updateViewMode);
        $(<span class="hljs-string">".return"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            $(<span class="hljs-string">'#view_mode'</span>).val(<span class="hljs-string">"Normal"</span>);
            WebSync.updateViewMode();
        });
        $(<span class="hljs-string">".fullscreen"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">if</span> (fullScreenApi.isFullScreen())
                fullScreenApi.cancelFullScreen();
            <span class="hljs-keyword">else</span>
                fullScreenApi.requestFullScreen(document.body);
        });
        <span class="hljs-built_in">require</span>([<span class="hljs-string">'edit'</span>]);
        <span class="hljs-keyword">this</span>.updateRibbon();
        rangy.init();
        console.log(rangy)
        $(<span class="hljs-string">'#settingsBtn'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            $(<span class="hljs-keyword">this</span>.parentElement).toggleClass(<span class="hljs-string">"active"</span>);
            $(<span class="hljs-string">".settings-popup"</span>).toggle();
            WebSync.resize();
        });
        $(<span class="hljs-string">'.settings-popup .close'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            $($(<span class="hljs-string">"#settingsBtn"</span>).get(<span class="hljs-number">0</span>).parentElement).toggleClass(<span class="hljs-string">"active"</span>);
            $(<span class="hljs-string">".settings-popup"</span>).toggle();
        });
        $(<span class="hljs-string">".settings-popup #diffs"</span>).delegate(<span class="hljs-string">'button'</span>, <span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            console.log(<span class="hljs-keyword">this</span>);
            <span class="hljs-keyword">var</span> patches = [];
            <span class="hljs-keyword">var</span> c_div = <span class="hljs-keyword">this</span>.parentElement.parentElement;
            <span class="hljs-keyword">var</span> id = <span class="hljs-built_in">parseInt</span>($(<span class="hljs-keyword">this</span>).data(<span class="hljs-string">"id"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>TODO: Tree based patches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; WebSync.patches.length; i++) {
                patches.push(WebSync.patches[i]);
                <span class="hljs-keyword">if</span> (WebSync.patches[i].id == id) {
                    i = WebSync.patches.length;
                }
            }
            console.log(patches.length);
            <span class="hljs-keyword">var</span> new_body = {
                body: []
            };
            _.each(patches, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(patch)</span> {</span>
                jsonpatch.apply(new_body, <span class="hljs-built_in">JSON</span>.parse(patch.patch));
            });
            console.log(new_body);
            _.each(WebSyncData, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, k)</span> {</span>
                <span class="hljs-keyword">delete</span> WebSyncData[k];
            });
            _.each(new_body, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, k)</span> {</span>
                WebSyncData[k] = v;
            });
            WebSyncData = new_body;
            <span class="hljs-keyword">if</span> (WebSync.fromJSON) {
                WebSync.fromJSON();
            }
            WebSync.checkDiff();
        });
        $(<span class="hljs-string">"a[href='#assets']"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            $(<span class="hljs-string">"#assets tbody"</span>).html(<span class="hljs-string">""</span>);
            WebSync.connection.sendJSON({
                type: <span class="hljs-string">'assets'</span>,
                action: <span class="hljs-string">'list'</span>
            });
        });
        $(<span class="hljs-string">".tab-pane#assets"</span>).delegate(<span class="hljs-string">".switch"</span>, <span class="hljs-string">"switch-change"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, data)</span> {</span>
            <span class="hljs-keyword">var</span> id = e.target.parentElement.parentElement.dataset.id;
            <span class="hljs-keyword">var</span> url = e.target.parentElement.parentElement.children[<span class="hljs-number">2</span>].innerText;
            WebSync.connection.sendJSON({
                type: <span class="hljs-string">'assets'</span>,
                action: (data.value ? <span class="hljs-string">'add'</span> : <span class="hljs-string">'delete'</span>),
                id: id
            });
            <span class="hljs-keyword">if</span> (data.value) {
                <span class="hljs-built_in">require</span>([url]);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-built_in">require</span>(url).disable();
                requirejs.undef(url);
            }
        });
        $(<span class="hljs-string">"a[href='#diffs']"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            $(<span class="hljs-string">"#diffs tbody"</span>).html(<span class="hljs-string">""</span>);
            WebSync.connection.sendJSON({
                type: <span class="hljs-string">'diffs'</span>,
                action: <span class="hljs-string">'list'</span>
            });
        });
        $(document).on(<span class="hljs-string">"online"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            NProgress.done();
        });
        <span class="hljs-keyword">this</span>.applier = rangy.createCssClassApplier(<span class="hljs-string">"tmp"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>TODO: Better polyfil for firefox not recognizing -moz-user-modify: read-write</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.resize();
        $(window).resize(<span class="hljs-keyword">this</span>.resize);
        WebSync.patchObserver = jsonpatch.observe(WebSyncData);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>this.setupWebRTC();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        clearTimeout(window.initError);
        window.initError = <span class="hljs-literal">true</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Variable: object WebSync.domExceptions;
This is where registerDOMException stores it’s internal data. You probably shouldn’t modify this directly.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    domExceptions: {},</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Function: void WebSync.registerDOMException(string Class, function Export, function Import);
This registers outside functions to handle the serialization &amp; parsing of certain classes. Used for modifyable content that can’t be serialized directly to HTML. Ex: the equation plugin.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    registerDOMException: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(watchClass, exportFunc, importFunc)</span> {</span>
        WebSync.domExceptions[watchClass] = {
            dump: exportFunc,
            load: importFunc
        };
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Function: void WebSync.unregisterDOMException(string Class);
Stops monitoring certain classes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    unregisterDOMException: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(watchClass)</span> {</span>
        <span class="hljs-keyword">delete</span> WebSync.domExceptions[watchClass];
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Variable: string WebSync.viewMode;
This is the current visual mode. This can be either ‘zen’ or ‘normal’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    viewMode: <span class="hljs-string">'normal'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Variable: boolean WebSync.menuVisible;
This tells you if the menu ribbon is visible or not. In zen mode it can disappear.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    menuVisible: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>WARNING: Experimental &amp; Unsupported in many browsers!
WebRTC Peer functionality. This will be used for communication between Clients. Video + Text chat hopefully.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setZoom: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(zoom)</span> {</span>
        WebSync.zoom = zoom;
        $(<span class="hljs-string">'#zoom_level'</span>).data(<span class="hljs-string">"slider"</span>).setValue(zoom * <span class="hljs-number">100</span>)
        <span class="hljs-keyword">var</span> container = $(<span class="hljs-string">".content_container"</span>);
        container.css({
            <span class="hljs-string">"transform"</span>: <span class="hljs-string">"scale("</span> + zoom + <span class="hljs-string">")"</span>
        });
        WebSync.updateOrigin();
        $(document).trigger(<span class="hljs-string">"zoom"</span>);
    },
    urlChange: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> current = window.location.pathname.split(<span class="hljs-string">"/"</span>)[<span class="hljs-number">2</span>]
        <span class="hljs-keyword">if</span> (current == <span class="hljs-string">"zen"</span>)
            $(<span class="hljs-string">"#view_mode"</span>).val(<span class="hljs-string">"Zen"</span>)
        <span class="hljs-keyword">if</span> (current == <span class="hljs-string">"view"</span>)
            $(<span class="hljs-string">"#view_mode"</span>).val(<span class="hljs-string">"Presentation"</span>)
        <span class="hljs-keyword">else</span>
            $(<span class="hljs-string">"#view_mode"</span>).val(<span class="hljs-string">"Normal"</span>)
        WebSync.updateViewMode(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
    },
    updateViewMode: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, dontPush)</span> {</span>
        <span class="hljs-keyword">var</span> mode = $(<span class="hljs-string">'#view_mode'</span>).val();
        WebSync.viewMode = mode;
        fullScreenApi.cancelFullScreen();
        <span class="hljs-keyword">if</span> (mode == <span class="hljs-string">'Zen'</span>) {
            $(<span class="hljs-string">"body"</span>).removeClass(<span class="hljs-string">"presentation"</span>).addClass(<span class="hljs-string">"zen"</span>).resize();
            WebSyncAuth.view_op = <span class="hljs-string">"edit"</span>;
            <span class="hljs-keyword">if</span> (!dontPush)
                window.history.pushState(<span class="hljs-string">""</span>, <span class="hljs-string">"WebSync - Zen Mode"</span>, <span class="hljs-string">"zen"</span>);
            $(<span class="hljs-string">"body"</span>).addClass(<span class="hljs-string">"zen"</span>).resize();
            $(<span class="hljs-string">"#zoom_level"</span>).data(<span class="hljs-string">"slider"</span>).setValue(<span class="hljs-number">120</span>);
            $(<span class="hljs-string">"#zoom_level"</span>).trigger(<span class="hljs-string">"slide"</span>);
            $(<span class="hljs-string">"nav"</span>).animate({
                top: -<span class="hljs-number">95</span>
            }, <span class="hljs-number">200</span>);
            $(<span class="hljs-string">".content_well"</span>).animate({
                top: <span class="hljs-number">0</span>
            }, <span class="hljs-number">200</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mode == <span class="hljs-string">'Presentation'</span>) {
            $(<span class="hljs-string">"body"</span>).removeClass(<span class="hljs-string">"edit"</span>).removeClass(<span class="hljs-string">"zen"</span>).addClass(<span class="hljs-string">"view"</span>).resize();
            WebSyncAuth.view_op = <span class="hljs-string">"view"</span>;
            <span class="hljs-keyword">if</span> (!dontPush)
                window.history.pushState(<span class="hljs-string">""</span>, <span class="hljs-string">"WebSync - Presentation Mode"</span>, <span class="hljs-string">"view"</span>);
            $(<span class="hljs-string">"nav"</span>).animate({
                top: -<span class="hljs-number">95</span>
            }, <span class="hljs-number">200</span>);
            $(<span class="hljs-string">".content_well, .sidebar"</span>).animate({
                top: <span class="hljs-number">0</span>
            }, <span class="hljs-number">200</span>);
            fullScreenApi.requestFullScreen(document.body);
        } <span class="hljs-keyword">else</span> {
            $(<span class="hljs-string">"body"</span>).removeClass(<span class="hljs-string">"zen"</span>).removeClass(<span class="hljs-string">"view"</span>).addClass(<span class="hljs-string">"edit"</span>).resize();
            WebSyncAuth.view_op = <span class="hljs-string">"edit"</span>;
            <span class="hljs-keyword">if</span> (!dontPush)
                window.history.pushState(<span class="hljs-string">""</span>, <span class="hljs-string">"WebSync - Edit Mode"</span>, <span class="hljs-string">"edit"</span>);
            $(<span class="hljs-string">"#zoom_level"</span>).data(<span class="hljs-string">"slider"</span>).setValue(<span class="hljs-number">100</span>);
            $(<span class="hljs-string">"#zoom_level"</span>).trigger(<span class="hljs-string">"slide"</span>);
            $(<span class="hljs-string">"nav"</span>).animate({
                top: <span class="hljs-number">0</span>
            }, <span class="hljs-number">200</span>);
            $(<span class="hljs-string">".content_well, .sidebar"</span>).animate({
                top: <span class="hljs-number">94</span>
            }, <span class="hljs-number">200</span>);
        }
        $(document).trigger(<span class="hljs-string">"viewmode"</span>);
    },
    setupWebRTC: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">if</span> (WebSync.createPeerConnection()) {
            WebSync.createDataChannel();
        }
    },
    createPeerConnection: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> pc_config = {
            <span class="hljs-string">"iceServers"</span>: [{
                <span class="hljs-string">"url"</span>: <span class="hljs-string">"stun:stun.l.google.com:19302"</span>
            }]
        };
        <span class="hljs-keyword">var</span> pc_constraints = {
            <span class="hljs-string">"optional"</span>: [{
                <span class="hljs-string">"RtpDataChannels"</span>: <span class="hljs-literal">true</span>
            }]
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Force the use of a number IP STUN server for Firefox.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (webrtcDetectedBrowser == <span class="hljs-string">"firefox"</span>) {
            pc_config = {
                <span class="hljs-string">"iceServers"</span>: [{
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"stun:23.21.150.121"</span>
                }]
            };
        }
        <span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Create an RTCPeerConnection via the polyfill (adapter.js).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            WebSync.pc = <span class="hljs-keyword">new</span> RTCPeerConnection(pc_config, pc_constraints);
            WebSync.pc.onicecandidate = WebSync.onIceCandidate;
            console.log(<span class="hljs-string">"Created RTCPeerConnnection with:\n"</span> +
                <span class="hljs-string">"  config: \""</span> + <span class="hljs-built_in">JSON</span>.stringify(pc_config) + <span class="hljs-string">"\";\n"</span> +
                <span class="hljs-string">"  constraints: \""</span> + <span class="hljs-built_in">JSON</span>.stringify(pc_constraints) + <span class="hljs-string">"\"."</span>);
        } <span class="hljs-keyword">catch</span> (e) {
            console.log(<span class="hljs-string">"Failed to create PeerConnection, exception: "</span> + e.message);
            alert(<span class="hljs-string">"Cannot create RTCPeerConnection object; WebRTC is not supported by this browser."</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        WebSync.pc.onaddstream = WebSync.onRemoteStreamAdded;
        WebSync.pc.onremovestream = WebSync.onRemoteStreamRemoved;
        WebSync.pc.ondatachannel = WebSync.onDataChannel;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    },
    createDataChannel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        WebSync.dataChannel = WebSync.pc.createDataChannel(<span class="hljs-string">"chat"</span>, {
            reliable: <span class="hljs-literal">false</span>
        });
        WebSync.dataChannel.onopen = WebSync.reportEvent;
        WebSync.dataChannel.onclose = WebSync.reportEvent;
        WebSync.dataChannel.onerror = WebSync.reportEvent;
        WebSync.dataChannel.onmessage = WebSync.reportEvent;
    },
    setupPeerOffer: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(isCaller)</span> {</span>
        <span class="hljs-keyword">if</span> (isCaller)
            WebSync.pc.createOffer(gotDescription);
        <span class="hljs-keyword">else</span>
            WebSync.pc.createAnswer(WebSync.pc.remoteDescription, gotDescription);

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gotDescription</span><span class="hljs-params">(desc)</span> {</span>
            pc.setLocalDescription(desc);
            signalingChannel.send(<span class="hljs-built_in">JSON</span>.stringify({
                <span class="hljs-string">"sdp"</span>: desc
            }));
        }
    },
    reportEvent: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        console.log(event);
    },
    onIceCanidate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onIceCandidate</span><span class="hljs-params">(event)</span> {</span>
        <span class="hljs-keyword">if</span> (event.candidate) {
            sendMessage({
                type: <span class="hljs-string">'candidate'</span>,
                label: event.candidate.sdpMLineIndex,
                id: event.candidate.sdpMid,
                candidate: event.candidate.candidate
            });
        } <span class="hljs-keyword">else</span> {
            console.log(<span class="hljs-string">"End of candidates."</span>);
        }
    },
    onRemoteStreamAdded: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onRemoteStreamAdded</span><span class="hljs-params">(event)</span> {</span>
        console.log(<span class="hljs-string">"Remote stream added."</span>);
        reattachMediaStream(miniVideo, localVideo);
        attachMediaStream(remoteVideo, event.stream);
        remoteStream = event.stream;
        waitForRemoteVideo();
    },
    onRemoteStreamRemoved: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onRemoteStreamRemoved</span><span class="hljs-params">(event)</span> {</span>
        console.log(<span class="hljs-string">"Remote stream removed."</span>);
    },
    onDataChannel: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        console.log(<span class="hljs-string">"Data Channel:"</span>, event);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Function: void WebSync.updateRibbon();
This updates the ribbon buttons based on the content in the ribbon bar. TODO: Use registration system &amp; persist menu between updates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    updateRibbon: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> menu_buttons = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">var</span> active = $(<span class="hljs-string">"#ribbon_buttons .active"</span>).text();
        $(<span class="hljs-string">".ribbon .container"</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem)</span> {</span>
            menu_buttons += <span class="hljs-string">'&lt;li'</span> + (<span class="hljs-keyword">this</span>.id == active ? <span class="hljs-string">' class="active"'</span> : <span class="hljs-string">""</span>) + <span class="hljs-string">'&gt;&lt;a&gt;'</span> + <span class="hljs-keyword">this</span>.id + <span class="hljs-string">'&lt;/a&gt;&lt;/li&gt;'</span>
        });
        $(<span class="hljs-string">'#ribbon_buttons'</span>).html(menu_buttons);
        $(<span class="hljs-string">'#ribbon_buttons li'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            $(<span class="hljs-string">'#ribbon_buttons li'</span>).removeClass(<span class="hljs-string">'active'</span>);
            $(<span class="hljs-keyword">this</span>).addClass(<span class="hljs-string">'active'</span>);
            $(<span class="hljs-string">'.ribbon .container'</span>).hide();
            $(<span class="hljs-string">"#"</span> + $(<span class="hljs-keyword">this</span>).text()).show();
        });
        <span class="hljs-keyword">if</span> (active == <span class="hljs-string">""</span>) $(<span class="hljs-string">'#ribbon_buttons li:contains(Text)'</span>).click();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Function: void WebSync.loadScripts();
Checks server for plugin scripts to load.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    loadScripts: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        WebSync.connection.sendJSON({
            type: <span class="hljs-string">"load_scripts"</span>
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Function: void WebSync.showHTML();
Converts visible text to HTML. TODO: Delete/figure something out.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    showHTML: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        $(<span class="hljs-string">'.page'</span>).html(<span class="hljs-string">"&lt;code&gt;"</span> + WebSync.getHTML() + <span class="hljs-string">"&lt;/code&gt;"</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Function: string WebSync.getHTML();
This will return sanitized document HTML. TODO: This should be migrated into the page handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getHTML: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        $(<span class="hljs-string">".page"</span>).get(<span class="hljs-number">0</span>).normalize();
        <span class="hljs-keyword">var</span> html = $(<span class="hljs-string">".page"</span>).html().trim();</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Remove other cursors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        html = html.replace(<span class="hljs-regexp">/\&lt;cursor[^\/]+\/?\&lt;\/cursor\&gt;/g</span>, <span class="hljs-string">""</span>)
        <span class="hljs-keyword">return</span> html;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Function: void WebSync.resize();
Event handler for when the window resizes. This is an internal method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    resize: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>$(“.content_well”).height(window.innerHeight-$(“.content_well”).position().top);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $(<span class="hljs-string">".arrow"</span>).offset({
            left: $(<span class="hljs-string">"#settingsBtn"</span>).parent().offset().left + <span class="hljs-number">13</span>
        });
        $(<span class="hljs-string">".settings-popup .popover-content"</span>).css({
            maxHeight: window.innerHeight - $(<span class="hljs-string">".settings-popup"</span>).offset().top - <span class="hljs-number">100</span>
        });
        WebSync.updateRibbon();
        WebSync.updateOrigin();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Function: void WebSync.updateOrigin();
Changes the transform origin based on the content_container dimensions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    updateOrigin: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> container = $(<span class="hljs-string">".content_container"</span>);
        <span class="hljs-keyword">if</span> (container.width() &gt; container.parent().width() || container.parent().get(<span class="hljs-number">0</span>) &amp;&amp; container.parent().get(<span class="hljs-number">0</span>).scrollWidth - <span class="hljs-number">2</span> &gt; container.parent().width()) {
            container.addClass(<span class="hljs-string">"left"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>TODO: Center zoomed out</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-comment">/*var side = container.parent().width() - container.width()*WebSync.zoom;
            if(side &gt; 0){
                container.css({"margin-left":  side/2});
            }*/</span>
        } <span class="hljs-keyword">else</span> {
            container.removeClass(<span class="hljs-string">"left"</span>);
            container.css({
                <span class="hljs-string">"margin-left"</span>: <span class="hljs-string">"auto"</span>
            });
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Function: void WebSync.checkDiff();
This is an internal method that executes every couple of seconds while the client is connected to the server. It checks to see if there have been any changes to document. If there are any changes it sends a message to a Web Worker to create a patch to transmit.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    checkDiff: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>if(!WebSync.oldData){
   WebSync.oldDataString = JSON.stringify(WebSyncData);
   WebSync.oldData = JSON.parse(WebSync.oldDataString);
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (WebSync.toJSON) {
            WebSync.toJSON();
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>var stringWebSync = JSON.stringify(WebSyncData);
if(stringWebSync!=WebSync.oldDataString){
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> patches = jsonpatch.generate(WebSync.patchObserver);
        <span class="hljs-keyword">if</span> (WebSyncAuth.access == <span class="hljs-string">"viewer"</span> &amp;&amp; patches.length &gt; <span class="hljs-number">0</span>) {
            WebSync.error(<span class="hljs-string">"&lt;b&gt;Error&lt;/b&gt; You don't have permission to make changes."</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (patches.length &gt; <span class="hljs-number">0</span>) {
            console.log(<span class="hljs-string">"Diffing"</span>, patches)
            $(document).trigger(<span class="hljs-string">"diffed"</span>);
            WebSync.connection.sendJSON({
                type: <span class="hljs-string">"data_patch"</span>,
                patch: patches
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>WebSync.oldDataString = stringWebSync;
WebSync.oldData = JSON.parse(stringWebSync);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Function: void WebSync.insertAtCursor(jQuery node);
Inserts a DOM element at selection cursor. This is probably going to be deprecated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    insertAtCursor: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(node)</span> {</span>
        node = node.get(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">var</span> sel, range, html;
        <span class="hljs-keyword">if</span> (window.getSelection) {
            sel = window.getSelection();
            <span class="hljs-keyword">if</span> (sel.getRangeAt &amp;&amp; sel.rangeCount) {
                range = sel.getRangeAt(<span class="hljs-number">0</span>);
                range.deleteContents();
                range.insertNode(node);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (document.selection &amp;&amp; document.selection.createRange) {
            document.selection.createRange().html = node;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Function: object WebSync.getCss();
Returns the calculated CSS for the current selection. Warning: This can cause the client to run slowly if used too much.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getCss: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-comment">/*WebSync.applier.toggleSelection();
		if($(".tmp").length==0) return {};
		return $(".tmp").removeClass("tmp").getStyleObject();*/</span>
        <span class="hljs-keyword">var</span> selection = getSelection();
        <span class="hljs-keyword">if</span> (selection.type == <span class="hljs-string">"None"</span>) {
            <span class="hljs-keyword">return</span> {};
        }
        <span class="hljs-keyword">var</span> selNode = getSelection().baseNode.parentNode;
        <span class="hljs-keyword">if</span> (WebSync.tmp.lastSelNode == selNode) {
            <span class="hljs-keyword">return</span> WebSync.tmp.lastSelCss;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> css_object = $(selNode).getStyleObject();
            WebSync.tmp.lastSelCss = css_object;
            WebSync.tmp.lastSelNode = selNode;
            <span class="hljs-keyword">return</span> css_object;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Function: void WebSync.applyCssToSelection(object css);
Applies css to the selection. Uses jQuery css object format. Warning: This is rather slow and shouldn’t be overly used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    applyCssToSelection: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(css)</span> {</span>
        WebSync.applier.toggleSelection();
        $(<span class="hljs-string">".tmp"</span>).css(css).removeClass(<span class="hljs-string">"tmp"</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Function: void WebSync.alert(string Message);
Displays an alert message in the lower right hand corner of the window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    alert: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span> {</span>
        <span class="hljs-keyword">return</span> WebSync.alertMessage(msg, <span class="hljs-string">"alert-warning"</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Function: void WebSync.error(string Message);
Displays an error message in the lower right hand corner of the window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    error: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span> {</span>
        <span class="hljs-keyword">return</span> WebSync.alertMessage(msg, <span class="hljs-string">"alert-danger"</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Function: void WebSync.success(string Message);
Displays a success message in the lower right hand corner of the window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    success: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span> {</span>
        <span class="hljs-keyword">return</span> WebSync.alertMessage(msg, <span class="hljs-string">"alert-success"</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Function: void WebSync.info(string Message);
Displays an info message in the lower right hand corner of the window.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    info: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span> {</span>
        <span class="hljs-keyword">return</span> WebSync.alertMessage(msg, <span class="hljs-string">"alert-info"</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Function: void WebSync.alertMessage(string Message, string Classes);
Displays an message in the lower right hand corner of the window with css classes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    alertMessage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg, classes)</span> {</span>
        <span class="hljs-keyword">var</span> div = $(<span class="hljs-string">'&lt;div class="alert '</span> + classes + <span class="hljs-string">'"&gt;&lt;a class="close" data-dismiss="alert"&gt;&amp;times;&lt;/a&gt;'</span> + msg + <span class="hljs-string">'&lt;/div&gt;'</span>);
        $(<span class="hljs-string">'#alert_well'</span>).prepend(div);
        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            div.alert(<span class="hljs-string">'close'</span>);
        }, <span class="hljs-number">10000</span>);
        <span class="hljs-keyword">return</span> div;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Function: void WebSync.fatalError(string Message);
Displays a large error banner. Should only be displayed for unrecoverable or interface blocking errors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fatalError: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg)</span> {</span>
        <span class="hljs-keyword">if</span> (msg) $(<span class="hljs-string">"#error_message"</span>).text(msg);
        $(<span class="hljs-string">"#fatal_error"</span>).fadeIn();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Function void WebSync.fatalHide();
Hides the fatal error banner.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fatalHide: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        $(<span class="hljs-string">"#fatal_error"</span>).fadeOut();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Function: void WebSync.applyPatchToDOM(element Parent, array Patches);
Applies a patch directly to the DOM instead of completely rebuilding it for each patch. BROKEN. Parses old patch system. DO NOT USE.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    applyPatchToDOM: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(element, patch)</span> {</span>
        <span class="hljs-keyword">if</span> (_.isArray(patch)) {
            console.log(<span class="hljs-string">"ARRAY"</span>, element, patch);
            _.each(patch, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem, index, list)</span> {</span>
                <span class="hljs-keyword">var</span> div = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">if</span> (elem.name == <span class="hljs-string">"#text"</span>) {
                    div = document.createTextNode(elem.textContent);
                } <span class="hljs-keyword">else</span> {
                    div = document.createElement(elem.name);
                }
                element.appendChild(div);
                WebSync.applyPatchToDOM(div, elem);
            });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (patch[<span class="hljs-string">"_t"</span>] == <span class="hljs-string">"a"</span>) {
                _.each(patch, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(val, key)</span> {</span>
                    <span class="hljs-keyword">if</span> (key != <span class="hljs-string">"_a"</span>) {
                        <span class="hljs-keyword">var</span> n_element = element.childNodes[<span class="hljs-built_in">parseInt</span>(key)];
                        <span class="hljs-keyword">if</span> (_.isArray(val)) {
                            _.each(val, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem, index, list)</span> {</span>
                                <span class="hljs-keyword">var</span> div = document.createElement(elem.name);
                                $(element).append(div);
                                WebSync.applyPatchToDOM(div, elem);
                            });
                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n_element) {
                            WebSync.applyPatchToDOM(n_element, val);
                        }
                    }
                });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (patch.childNodes) {
                    WebSync.applyPatchToDOM(element, patch.childNodes);
                }
                <span class="hljs-keyword">if</span> (patch.textContent) {
                    <span class="hljs-keyword">if</span> (_.isArray(patch.textContent)) {
                        element.textContent = patch.textContent[<span class="hljs-number">1</span>];
                    } <span class="hljs-keyword">else</span> {
                        element.textContent = patch.textContent;
                    }
                }
                _.each(patch, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, k)</span> {</span>
                    <span class="hljs-keyword">if</span> (k != <span class="hljs-string">"name"</span> &amp;&amp; k != <span class="hljs-string">"textContent"</span> &amp;&amp; k != <span class="hljs-string">"childNodes"</span> &amp;&amp; k != <span class="hljs-string">"dataset"</span>) {
                        $(element).attr(k, v);
                    }
                });
                <span class="hljs-keyword">if</span> (patch.dataset) {
                    _.each(patch.dataset, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, k)</span> {</span>
                        $(element).attr(<span class="hljs-string">"data-"</span> + k, v);
                    });
                }
            }
        }
    }
});
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>This is used to know when all modules are loaded. It uses a sketchy internal function subject to change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    requirejs.onResourceLoad = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(context, map, depArray)</span> {</span>
        <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">var</span> context = requirejs.s.contexts._;
        <span class="hljs-keyword">var</span> loaded = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> total = <span class="hljs-number">0</span>;
        _.each(context.urlFetched, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fetched, script)</span> {</span>
            <span class="hljs-keyword">if</span> (fetched &amp;&amp; context.defined[script]) {
                loaded += <span class="hljs-number">1</span>;
            }
            total += <span class="hljs-number">1</span>;
        });
        <span class="hljs-keyword">if</span> (loaded == total &amp;&amp; total &gt; <span class="hljs-number">0</span>) {
            $(document).trigger(<span class="hljs-string">"modules_loaded"</span>);
            done = <span class="hljs-literal">true</span>;
        }
    }
})();
dmp = <span class="hljs-keyword">new</span> diff_match_patch();

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NODEtoJSON</span><span class="hljs-params">(obj)</span> {</span>
    <span class="hljs-keyword">var</span> jso = {
        name: obj.nodeName,
        childNodes: []
    }
    <span class="hljs-keyword">var</span> exempt = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (WebSync.domExceptions[obj.nodeName]) {
        exempt = obj.nodeName;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (WebSync.domExceptions[<span class="hljs-string">"#"</span> + obj.id]) {
        exempt = <span class="hljs-string">"#"</span> + obj.id;
    } <span class="hljs-keyword">else</span> {
        _.each(obj.classList, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cl)</span> {</span>
            <span class="hljs-keyword">if</span> (WebSync.domExceptions[<span class="hljs-string">"."</span> + cl]) {
                exempt = <span class="hljs-string">"."</span> + cl;
            }
        });
    }
    <span class="hljs-keyword">if</span> (exempt) {
        <span class="hljs-keyword">delete</span> jso.childNodes;
        jso.exempt = exempt;
        jso.data = WebSync.domExceptions[exempt].dump(obj);
        <span class="hljs-keyword">return</span> jso;
    }
    <span class="hljs-keyword">var</span> search_children = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">if</span> (_.size(obj.dataset) &gt; <span class="hljs-number">0</span>) {
        jso.dataset = {}
        _.each(obj.dataset, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, k)</span> {</span>
            jso.dataset[k] = v;
        });
        <span class="hljs-keyword">if</span> (jso.dataset.search_children == <span class="hljs-string">"false"</span>) {
            search_children = <span class="hljs-literal">false</span>;
        }
    }
    <span class="hljs-keyword">if</span> (obj.nodeName == <span class="hljs-string">"#text"</span>) {
        jso.textContent = obj.textContent;
    }
    <span class="hljs-keyword">if</span> (obj.attributes) {
        _.each(obj.attributes, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, k)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>TODO: Add blacklist of classnames &amp; attributes for DOM serialization.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (v.name != <span class="hljs-string">"contenteditable"</span> &amp;&amp; v.name.indexOf(<span class="hljs-string">"data-"</span>) != <span class="hljs-number">0</span>) {
                jso[v.name] = v.value;
            }
        });
    }
    <span class="hljs-keyword">if</span> (search_children) {
        _.each(obj.childNodes, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(child, index)</span> {</span>
            jso.childNodes.push(NODEtoJSON(child));
        });
    }
    <span class="hljs-keyword">if</span> (_.isEmpty(jso.childNodes)) {
        <span class="hljs-keyword">delete</span> jso.childNodes;
    }
    <span class="hljs-keyword">return</span> jso;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DOMToJSON</span><span class="hljs-params">(obj)</span> {</span>
    <span class="hljs-keyword">var</span> jso = [];
    _.each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem, index)</span> {</span>
        elem.normalize();
        jso.push(NODEtoJSON(elem));
    });
    <span class="hljs-keyword">return</span> jso;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">escapeHTML</span><span class="hljs-params">(html)</span> {</span>
    <span class="hljs-keyword">return</span> html.replace(<span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">"&amp;amp;"</span>).replace(<span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">"&amp;lt;"</span>).replace(<span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">"&amp;gt;"</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">alphaNumeric</span><span class="hljs-params">(text)</span> {</span>
    <span class="hljs-keyword">return</span> text.match(<span class="hljs-regexp">/[a-zA-Z0-9\-]+/g</span>).join(<span class="hljs-string">""</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">NODEtoDOM</span><span class="hljs-params">(obj)</span> {</span>
    <span class="hljs-keyword">var</span> html = <span class="hljs-string">""</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Some basic cross site scripting attack prevention.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (obj.name == <span class="hljs-string">"#text"</span>)
        <span class="hljs-keyword">return</span> escapeHTML(obj.textContent);
    obj.name = alphaNumeric(obj.name);</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>TODO: Potentially disallow iframes!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (obj.name == <span class="hljs-string">"script"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    <span class="hljs-keyword">if</span> (obj.exempt &amp;&amp; WebSync.domExceptions[obj.exempt]) {
        <span class="hljs-keyword">return</span> WebSync.domExceptions[obj.exempt].load(obj.data);
    }
    html += <span class="hljs-string">"&lt;"</span> + obj.name;
    <span class="hljs-keyword">var</span> data_vars = []
    _.each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, k)</span> {</span>
        <span class="hljs-keyword">if</span> (k != <span class="hljs-string">"name"</span> &amp;&amp; k != <span class="hljs-string">"textContent"</span> &amp;&amp; k != <span class="hljs-string">"childNodes"</span> &amp;&amp; k != <span class="hljs-string">"dataset"</span>) {
            k = alphaNumeric(k.trim())
            <span class="hljs-keyword">if</span> (k.toLowerCase().indexOf(<span class="hljs-string">"on"</span>) != <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">if</span> (k.toLowerCase().indexOf(<span class="hljs-string">"data-"</span>) == <span class="hljs-number">0</span>) {
                    data_vars.push(k)
                }
                html += <span class="hljs-string">" "</span> + k + <span class="hljs-string">"="</span> + <span class="hljs-built_in">JSON</span>.stringify(v);
            }
        }
    });
    <span class="hljs-keyword">if</span> (obj.dataset) {
        _.each(obj.dataset, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v, k)</span> {</span>
            k = alphaNumeric(k.trim());
            <span class="hljs-keyword">if</span> (data_vars.indexOf(<span class="hljs-string">"data-"</span> + k) == -<span class="hljs-number">1</span>)
                html += <span class="hljs-string">" data-"</span> + alphaNumeric(k) + <span class="hljs-string">"="</span> + <span class="hljs-built_in">JSON</span>.stringify(v);
        });
    }
    <span class="hljs-keyword">if</span> (obj.childNodes) {
        html += <span class="hljs-string">"&gt;"</span>;
        _.each(obj.childNodes, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem, index)</span> {</span>
            html += NODEtoDOM(elem);
        });
        html += <span class="hljs-string">"&lt;/"</span> + obj.name + <span class="hljs-string">"&gt;"</span>;
    } <span class="hljs-keyword">else</span> {
        html += <span class="hljs-string">"/&gt;"</span>;
    }
    <span class="hljs-keyword">return</span> html;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">JSONToDOM</span><span class="hljs-params">(obj)</span> {</span>
    <span class="hljs-keyword">var</span> html = <span class="hljs-string">""</span>;
    _.each(obj, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(elem, index)</span> {</span>
        html += NODEtoDOM(elem);
    });
    <span class="hljs-keyword">return</span> html;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Finds differences between obj1 and obj2.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">diff</span><span class="hljs-params">(obj1, obj2)</span> {</span>
    <span class="hljs-keyword">var</span> diffs = {}
    <span class="hljs-keyword">if</span> (_.isEqual(obj1, obj2)) {} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(obj2) == <span class="hljs-string">'undefined'</span>) {
        diffs = {
            op: <span class="hljs-string">'delete'</span>
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(obj1) != <span class="hljs-keyword">typeof</span>(obj2)) {
        diffs = {
            op: <span class="hljs-string">'replace'</span>,
            <span class="hljs-keyword">new</span>: obj2
        };
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(obj1) == <span class="hljs-string">"string"</span>) {
        diffs = {
            op: <span class="hljs-string">'patch'</span>,
            patch: dmp.patch_toText(dmp.patch_make(obj1, obj2))
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($.isArray(obj1)) {
        diffs = [];
        <span class="hljs-keyword">var</span> C = []</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Generate a table of matching areas.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $.each(obj2, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i1, val1)</span> {</span>
            C[i1] = []
            $.each(obj1, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i2, val2)</span> {</span>
                <span class="hljs-keyword">if</span> (_.isEqual(val1, val2)) {
                    C[i1][i2] = <span class="hljs-literal">true</span>;
                }
            });
        });
        log_array(C);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>First pass through C looking for non-matching patterns found in the new array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> last_i2 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> last_i1 = <span class="hljs-number">0</span>;
        $.each(C, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i1, R)</span> {</span>
            <span class="hljs-keyword">var</span> exists = <span class="hljs-literal">false</span>;
            $.each(R, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i2, val)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>This deletes duplicates.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (val &amp;&amp; exists) {
                    <span class="hljs-keyword">delete</span> C[i1][i2];
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val) {
                    exists = <span class="hljs-literal">true</span>;
                    <span class="hljs-comment">/*var x = last_i1;
                    var y = last_i2;
                    while(x!=i1&amp;&amp;y!=i2){
                        var slope_x = 0;
                        var slope_y = 0;
                        if(x!=i1){
                            slope_x = 1;
                        }
                        if(y!=i2){
                            slope_y = 1;
                        }
                        x+=slope_x;
                        y+=slope_y;
                        if(!C[x][y]){
                            if(slope_x&amp;&amp;slope_y){
                                console.log(x,y,obj1,obj2);
                                diffs.push({op:'diff',index:i2,diff:diff(obj1[y-1],obj2[x])});
                            } else if(slope_x){
                                diffs.push({op:'new',new:obj2[x],index:x});
                            } else if(slope_y){
                                diffs.push({op:'delete',index:y});
                            }
                        }
                        for(var b=(x+2);b&lt;C.length;b++){
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Prune the rest of the false positives on this line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">delete</span> C[b][y];
                        }
                    }<span class="hljs-comment">//*/</span>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = (last_i2); y &lt; i2; y++) {
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> b = (i1 + <span class="hljs-number">1</span>); b &lt; C.length; b++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Prune the rest of the false positives on this line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">delete</span> C[b][y];
                        }
                    }
                    last_i2 = i2;
                    last_i1 = i1;
                }
            });
            <span class="hljs-keyword">if</span> (!exists) {
                <span class="hljs-keyword">var</span> action = {
                    op: <span class="hljs-string">'new'</span>,
                    <span class="hljs-keyword">new</span>: obj2[i1],
                    index: i1
                }
                last_i2++;
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = (i1 + <span class="hljs-number">1</span>); x &lt; C.length; x++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Prune the rest of the false positives on this line.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">delete</span> C[x][last_i2];
                }
                diffs.push(action)
            }
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Second pass through C looking for non-matching patterns found in the old array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i1 = <span class="hljs-number">0</span>; i1 &lt; obj1.length; i1++) {
            <span class="hljs-keyword">var</span> exists = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i2 = <span class="hljs-number">0</span>; i2 &lt; obj2.length; i2++) {
                <span class="hljs-keyword">if</span> (C[i2][i1]) {
                    exists = <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-keyword">if</span> (!exists) {
                diffs.push({
                    op: <span class="hljs-string">'delete'</span>,
                    index: i1
                })
            }
        } <span class="hljs-comment">//*/</span>
        <span class="hljs-comment">/*var tmp_diff = [];
        for(var i=(diffs.length-1);i&gt;=0;i--){
            var diff = diffs[i];
            var diff_index = tmp_diff[diff.index];
            if(diff_index!=null){
                {op:'diff',diff:diff(obj1[diff_index],obj2[diff_index]);
                delete diffs[diff_index];
                delete diffs[i];
            } else {
                tmp_diff[diff.index]=i;
            }
        }*/</span>
        log_array(C);
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Both Objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $.each(obj1, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k, v)</span> {</span>
            <span class="hljs-keyword">var</span> val = diff(v, obj2[k]);
            <span class="hljs-keyword">if</span> (!_.isEmpty(val)) {
                diffs[k] = val;
            }
        });
    }
    <span class="hljs-keyword">return</span> diffs;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log_array</span><span class="hljs-params">(arr)</span> {</span>
    <span class="hljs-keyword">var</span> output = <span class="hljs-string">""</span>;
    $.each(arr, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i1, R)</span> {</span>
        <span class="hljs-keyword">var</span> exists = <span class="hljs-literal">false</span>;
        $.each(R, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i2, val)</span> {</span>
            <span class="hljs-keyword">if</span> (val) {
                output += <span class="hljs-string">'0'</span>;
            } <span class="hljs-keyword">else</span> {
                output += <span class="hljs-string">' '</span>;
            }
        });
        output += <span class="hljs-string">"\n"</span>;
    });
    console.log(output);

}
WebSocket.prototype.sendJSON = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(object)</span> {</span>
    <span class="hljs-keyword">this</span>.send(<span class="hljs-built_in">JSON</span>.stringify(object));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">capitaliseFirstLetter</span><span class="hljs-params">(string)</span> {</span>
    <span class="hljs-keyword">return</span> string.charAt(<span class="hljs-number">0</span>).toUpperCase() + string.slice(<span class="hljs-number">1</span>);
}

requirejs.config({
    baseUrl: <span class="hljs-string">'assets'</span>
});
$(document).ready(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-built_in">require</span>([<span class="hljs-string">'websync'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(websync)</span> {</span>
        window.WebSync = websync;
        WebSync.initialize();
    });
});</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Polyfill for non-standard webkit method scrollIntoViewIfNeeded by Hubert SABLONNIERE @hsablonniere</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (!Element.prototype.scrollIntoViewIfNeeded) {
    Element.prototype.scrollIntoViewIfNeeded = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(centerIfNeeded)</span> {</span>
        centerIfNeeded = <span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">0</span> ? <span class="hljs-literal">true</span> : !! centerIfNeeded;
        <span class="hljs-keyword">var</span> parent = <span class="hljs-keyword">this</span>.parentNode,
            parentComputedStyle = window.getComputedStyle(parent, <span class="hljs-literal">null</span>),
            parentBorderTopWidth = <span class="hljs-built_in">parseInt</span>(parentComputedStyle.getPropertyValue(<span class="hljs-string">'border-top-width'</span>)),
            parentBorderLeftWidth = <span class="hljs-built_in">parseInt</span>(parentComputedStyle.getPropertyValue(<span class="hljs-string">'border-left-width'</span>)),
            overTop = <span class="hljs-keyword">this</span>.offsetTop - parent.offsetTop &lt; parent.scrollTop,
            overBottom = (<span class="hljs-keyword">this</span>.offsetTop - parent.offsetTop + <span class="hljs-keyword">this</span>.clientHeight - parentBorderTopWidth) &gt; (parent.scrollTop + parent.clientHeight),
            overLeft = <span class="hljs-keyword">this</span>.offsetLeft - parent.offsetLeft &lt; parent.scrollLeft,
            overRight = (<span class="hljs-keyword">this</span>.offsetLeft - parent.offsetLeft + <span class="hljs-keyword">this</span>.clientWidth - parentBorderLeftWidth) &gt; (parent.scrollLeft + parent.clientWidth),
            alignWithTop = overTop &amp;&amp; !overBottom;
        <span class="hljs-keyword">if</span> ((overTop || overBottom) &amp;&amp; centerIfNeeded) {
            parent.scrollTop = <span class="hljs-keyword">this</span>.offsetTop - parent.offsetTop - parent.clientHeight / <span class="hljs-number">2</span> - parentBorderTopWidth + <span class="hljs-keyword">this</span>.clientHeight / <span class="hljs-number">2</span>;
        }
        <span class="hljs-keyword">if</span> ((overLeft || overRight) &amp;&amp; centerIfNeeded) {
            parent.scrollLeft = <span class="hljs-keyword">this</span>.offsetLeft - parent.offsetLeft - parent.clientWidth / <span class="hljs-number">2</span> - parentBorderLeftWidth + <span class="hljs-keyword">this</span>.clientWidth / <span class="hljs-number">2</span>;
        }
        <span class="hljs-keyword">if</span> ((overTop || overBottom || overLeft || overRight) &amp;&amp; !centerIfNeeded) {
            <span class="hljs-keyword">this</span>.scrollIntoView(alignWithTop);
        }
    };
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
